---
alwaysApply: false
---

# Cursor Rules for Blumiq Project

## Project Overview
This is a Next.js loan application platform (Blumiq) with complete authentication, OTP verification, admin dashboard, payment processing, document management, and multi-bank loan processing capabilities.

## Critical Implementation Patterns

### Authentication System
- **ALWAYS** use `withAuth` HOF for protected API routes
- **ALWAYS** use `withAdminAuth` HOF for admin-only API routes
- **NEVER** expose passwords or OTPs in API responses
- **ALWAYS** hash passwords with bcrypt (salt rounds: 10)
- **ALWAYS** validate phone numbers with Indian format: `/^[6-9]\d{9}$/`
- **ALWAYS** use E.164 format for Twilio SMS: `+919876543210`
- **ALWAYS** implement email verification for user accounts

### Database Patterns
- **PREFER** Mongoose models when available over native MongoDB driver
- **ALWAYS** use cached database connection from `src/lib/mongodb.ts`
- **ALWAYS** exclude sensitive fields in toJSON transform (password, phone_otp)
- **ALWAYS** use timestamps: true in Mongoose schemas
- **ALWAYS** validate required fields with proper error messages

### API Route Structure
```typescript
// Standard API route pattern
export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    
    // Validation
    if (!body.requiredField) {
      return NextResponse.json({ error: 'Missing required field' }, { status: 400 });
    }
    
    // Business logic
    const result = await processData(body);
    
    return NextResponse.json({ result }, { status: 201 });
  } catch (error) {
    console.error('API Error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

### Error Handling
- **ALWAYS** use standardized error response format
- **ALWAYS** log errors with context (timestamp, URL, user info)
- **ALWAYS** return appropriate HTTP status codes
- **NEVER** expose internal error details in production

### Component Patterns
- **USE** 'use client' directive only when interactivity is needed
- **PREFER** server components for static content
- **ALWAYS** wrap with ThemeRegistry for Material-UI components
- **ALWAYS** use TypeScript interfaces for props

### Material-UI Grid v7 API
- **ALWAYS** use the new Grid v7 API syntax for MUI v7+
- **NEVER** use the deprecated `item` prop
- **ALWAYS** use `size` prop with breakpoint object instead of individual breakpoint props

```tsx
// ✅ Correct (Grid v7 API)
<Grid size={{ xs: 12, md: 6 }}>
<Grid size={{ xs: 12, sm: 6, md: 3 }}>
<Grid size={{ xs: 12 }}>

// ❌ Incorrect (Deprecated Grid v1 API)
<Grid item xs={12} md={6}>
<Grid item xs={12} sm={6} md={3}>
<Grid item xs={12}>
```

**Migration Pattern:**
- Remove `item` prop completely
- Move all breakpoint props (`xs`, `sm`, `md`, `lg`, `xl`) into `size` object
- Keep `container` prop unchanged for grid containers

## Environment Variables
**CRITICAL**: Never commit these to version control:
- `MONGODB_URI`
- `ACCESS_TOKEN_SECRET` (32+ characters)
- `REFRESH_TOKEN_SECRET` (32+ characters)
- `TWILIO_ACCOUNT_SID`
- `TWILIO_AUTH_TOKEN`
- `TWILIO_PHONE_NUMBER`
- `RAZORPAY_KEY_ID`
- `RAZORPAY_KEY_SECRET`
- `RAZORPAY_WEBHOOK_SECRET`
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_S3_BUCKET_NAME`
- `AWS_REGION`
- `SMTP_HOST`
- `SMTP_PORT`
- `SMTP_USER`
- `SMTP_PASS`
- `SMTP_FROM`

## Code Organization Rules

### File Structure
- API routes: `src/app/api/[feature]/route.ts`
- Admin API routes: `src/app/api/admin/[feature]/route.ts`
- Pages: `src/app/[feature]/page.tsx`
- Admin pages: `src/app/admin/[feature]/page.tsx`
- Dashboard pages: `src/app/dashboard/[feature]/page.tsx`
- Components: `src/components/[Feature]/ComponentName.tsx`
- Common components: `src/components/Common/ComponentName.tsx`
- Admin components: `src/components/Admin/ComponentName.tsx`
- Dashboard components: `src/components/Dashboard/ComponentName.tsx`
- Utilities: `src/lib/[utility].ts`
- Models: `src/models/[Model].ts`

### Naming Conventions
- **Files**: kebab-case for pages, PascalCase for components
- **Variables**: camelCase
- **Constants**: UPPER_SNAKE_CASE
- **Interfaces**: PascalCase with 'I' prefix (e.g., `IUser`)
- **Types**: PascalCase

### Import Order
1. React/Next.js imports
2. Third-party libraries
3. Internal components
4. Utilities and types
5. Relative imports

## Security Rules

### Input Validation
- **ALWAYS** validate all user inputs
- **ALWAYS** sanitize data before database operations
- **ALWAYS** use proper regex patterns for validation
- **NEVER** trust client-side validation alone

### Authentication
- **ALWAYS** verify JWT tokens before processing requests
- **ALWAYS** check user permissions for sensitive operations
- **ALWAYS** use HTTPS in production
- **NEVER** store sensitive data in localStorage

### Database Security
- **ALWAYS** use parameterized queries
- **ALWAYS** validate ObjectId format before database queries
- **ALWAYS** implement proper indexing for performance
- **NEVER** expose database connection strings

## Performance Rules

### Database Queries
- **ALWAYS** use indexes for frequently queried fields
- **ALWAYS** limit query results with pagination
- **ALWAYS** use projection to exclude unnecessary fields
- **NEVER** use `find()` without limits on large collections

### API Performance
- **ALWAYS** implement proper error handling
- **ALWAYS** use connection pooling for database
- **ALWAYS** cache frequently accessed data
- **NEVER** block the event loop with synchronous operations

### Frontend Performance
- **ALWAYS** use dynamic imports for large components
- **ALWAYS** optimize images and assets
- **ALWAYS** implement proper loading states
- **NEVER** load unnecessary data on initial page load

## Business Logic Rules

### User Types
- `customer`: Standard loan applicants
- `cash_lending_customer`: Premium subscription users
- `admin`: Platform administrators

### Loan Application Status
- `draft`: Initial state
- `submitted`: User submitted application
- `under_review`: Admin reviewing
- `requires_documents`: Need more documents
- `approved`: Loan approved
- `rejected`: Loan rejected
- `disbursed`: Funds disbursed
- `closed`: Loan closed
- `cancelled`: Application cancelled

### Membership Card Status
- `active`: Card is active and benefits available
- `expired`: Card has expired
- `cancelled`: Card was cancelled

### Payment Processing
- **ALWAYS** use Razorpay for payment processing
- **ALWAYS** verify payment signatures before processing
- **ALWAYS** handle payment failures gracefully
- **ALWAYS** send payment confirmation emails

### Document Management
- **ALWAYS** use AWS S3 for document storage
- **ALWAYS** generate presigned URLs for secure access
- **ALWAYS** validate file types and sizes
- **ALWAYS** implement proper access controls

### Email Notifications
- **ALWAYS** send email notifications for loan status changes
- **ALWAYS** use professional email templates
- **ALWAYS** handle email sending failures gracefully
- **ALWAYS** log email delivery status

## Development Workflow

### Git Workflow
- **ALWAYS** create feature branches from main
- **ALWAYS** write descriptive commit messages
- **ALWAYS** test changes before committing
- **NEVER** commit directly to main branch

### Code Review
- **ALWAYS** review security implications
- **ALWAYS** check error handling
- **ALWAYS** verify input validation
- **ALWAYS** test API endpoints

### Testing
- **ALWAYS** test authentication flows
- **ALWAYS** test error scenarios
- **ALWAYS** test with invalid inputs
- **NEVER** deploy without testing

## Common Patterns

### JWT Token Generation
```typescript
const accessToken = generateAccessToken({
  userId: user._id.toString(),
  userType: user.user_type
});
```

### Database Connection
```typescript
const db = await connectToDatabase();
const result = await db.collection('users').findOne({ email });
```

### Protected Route
```typescript
const protectedHandler = async (req: NextRequestWithUser) => {
  const user = req.user; // Available from withAuth
  // Handler logic
};
export const GET = withAuth(protectedHandler);
```

### Admin Protected Route
```typescript
const adminHandler = async (req: NextRequestWithAdmin) => {
  const admin = req.admin; // Available from withAdminAuth
  // Admin handler logic
};
export const GET = withAdminAuth(adminHandler);
```

### Payment Processing
```typescript
// Create Razorpay order
const order = await createRazorpayOrder(amount, currency);

// Verify payment
const isValid = await verifyPayment(paymentData);
```

### Document Upload
```typescript
// Upload to S3
const result = await uploadToS3(fileBuffer, fileName, contentType);

// Generate presigned URL
const url = await generatePresignedUrl(s3Key, expiresIn);
```

### Email Notification
```typescript
// Send loan approval email
await EmailService.sendLoanApprovalNotification(
  user.email,
  user.full_name,
  applicationId,
  approvedAmount,
  interestRate,
  tenureMonths
);
```

### Form Validation with Zod
```typescript
import { validateData, userRegistrationSchema } from '@/lib/validation';

const validation = validateData(userRegistrationSchema, body);
if (!validation.success) {
  return NextResponse.json({
    error: 'Validation failed',
    details: validation.errors
  }, { status: 400 });
}

const validatedData = validation.data;
```

### Component Usage
```typescript
// Use reusable components
import { Button, Input, Card, LoadingSpinner } from '@/components/Common';
import { ContactForm, LoanApplicationForm } from '@/components/Forms';
import { StatsCard, DataTable, StatusBadge } from '@/components/Admin';
```

## Anti-Patterns to Avoid

### Security Anti-Patterns
- ❌ Storing passwords in plain text
- ❌ Exposing sensitive data in API responses
- ❌ Not validating user inputs
- ❌ Using weak JWT secrets
- ❌ Not implementing rate limiting

### Performance Anti-Patterns
- ❌ N+1 database queries
- ❌ Loading all data without pagination
- ❌ Not using database indexes
- ❌ Blocking operations in API routes
- ❌ Not implementing caching

### Code Quality Anti-Patterns
- ❌ Inconsistent error handling
- ❌ Not using TypeScript types
- ❌ Mixing server and client components unnecessarily
- ❌ Not following naming conventions
- ❌ Not documenting complex logic

## Project-Specific Notes

### Phone Number Handling
- Store in Indian format: `9876543210`
- Convert to E.164 for Twilio: `+919876543210`
- Validate with: `/^[6-9]\d{9}$/`

### OTP Implementation
- Generate 6-digit numeric OTP
- Store with expiration time
- Send via Twilio SMS
- Validate within time window

### Membership Benefits
- Silver Card: 30-minute personal loan processing
- Gold Card: 48-hour business loan processing
- Both provide preferential rates and priority support

### Bank Partner Integration
- Store partner information in `bank_partners` collection
- Link applications to specific partners
- Track partner performance and approval rates

## Emergency Procedures

### Security Incident
1. Immediately revoke compromised tokens
2. Check logs for suspicious activity
3. Update secrets and passwords
4. Notify team and users if necessary

### Database Issues
1. Check connection status
2. Verify environment variables
3. Check MongoDB service status
4. Review recent code changes

### Performance Issues
1. Check database query performance
2. Review API response times
3. Check for memory leaks
4. Monitor error rates

## Documentation Requirements

### API Documentation
- **ALWAYS** document request/response formats
- **ALWAYS** include example requests
- **ALWAYS** document error responses
- **ALWAYS** specify required fields

### Code Documentation
- **ALWAYS** document complex business logic
- **ALWAYS** explain non-obvious decisions
- **ALWAYS** document API integrations
- **ALWAYS** update documentation with code changes

## Quality Assurance

### Before Deployment
- [ ] All tests passing
- [ ] Security review completed
- [ ] Performance testing done
- [ ] Documentation updated
- [ ] Environment variables configured
- [ ] Database migrations applied

### Post-Deployment
- [ ] Monitor error rates
- [ ] Check performance metrics
- [ ] Verify functionality
- [ ] Monitor user feedback
- [ ] Check security logs

## TypeScript & ESLint Rules

### TypeScript Best Practices

#### 1. Avoid `any` Types
**❌ Bad:**
```typescript
const data: any = response.data;
const user = (row as any).user_id;
```

**✅ Good:**
```typescript
const data: { id: string; name: string } = response.data;
const user = (row as { user_id: string }).user_id;
```

#### 2. Proper Type Assertions
**❌ Bad:**
```typescript
color={getStatusColor(status) as any}
```

**✅ Good:**
```typescript
color={getStatusColor(status) as 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning'}
```

#### 3. API Route Function Signatures
**❌ Bad:**
```typescript
export async function POST(req: NextRequest) {
```

**✅ Good:**
```typescript
export async function POST(req: Request) {
// or for no parameters:
export async function GET() {
```

#### 4. Mongoose Model Property Access
**❌ Bad:**
```typescript
user.last_login = new Date();
admin._id.toString()
```

**✅ Good:**
```typescript
(user as { last_login?: Date }).last_login = new Date();
(admin._id as { toString(): string }).toString()
```

#### 5. Validation Data Types
**❌ Bad:**
```typescript
const validatedData = validation.data as any;
```

**✅ Good:**
```typescript
const validatedData = validation.data as { 
  approved_amount: number; 
  interest_rate: number; 
  tenure_months: number; 
  processing_fee: number; 
  remarks?: string; 
};
```

### React Hooks Rules

#### 1. useEffect Dependencies
**❌ Bad:**
```typescript
useEffect(() => {
  fetchData();
}, []);
```

**✅ Good:**
```typescript
const fetchData = useCallback(async () => {
  // fetch logic
}, [dependency1, dependency2]);

useEffect(() => {
  fetchData();
}, [fetchData]);
```

#### 2. Unused Variables
**❌ Bad:**
```typescript
const [selectedRowId, setSelectedRowId] = useState<string | null>(null);
// selectedRowId never used
```

**✅ Good:**
```typescript
const [, setSelectedRowId] = useState<string | null>(null);
// or remove entirely if not needed
```

#### 3. Unused Parameters
**❌ Bad:**
```typescript
const handleClick = (event: React.MouseEvent) => {
  // event not used
};
```

**✅ Good:**
```typescript
const handleClick = (_event: React.MouseEvent) => {
  // or remove parameter if not needed
};
```

### Material-UI Component Rules

#### 1. ListItem Usage
**❌ Bad:**
```typescript
<ListItem button onClick={handleClick}>
```

**✅ Good:**
```typescript
<ListItem disablePadding>
  <ListItemButton onClick={handleClick}>
    <ListItemIcon>{icon}</ListItemIcon>
    <ListItemText primary={text} />
  </ListItemButton>
</ListItem>
```

#### 2. Chip Color Props
**❌ Bad:**
```typescript
<Chip color={getColor() as any} />
```

**✅ Good:**
```typescript
<Chip color={getColor() as 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning'} />
```

### Import Management Rules

#### 1. Remove Unused Imports
**❌ Bad:**
```typescript
import { 
  CheckCircle, 
  Warning, 
  Error, 
  Schedule,
  TrendingUp 
} from '@mui/icons-material';
// Only CheckCircle is used
```

**✅ Good:**
```typescript
import { CheckCircle } from '@mui/icons-material';
```

#### 2. NextRequest vs Request
**❌ Bad:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
export async function GET(req: NextRequest) {
```

**✅ Good:**
```typescript
import { NextResponse } from 'next/server';
export async function GET(req: Request) {
// or
export async function GET() {
```

### String Escaping Rules

#### 1. Unescaped Entities
**❌ Bad:**
```typescript
<Typography>Don't let funding constraints limit your business growth.</Typography>
<Typography>"This is a quote"</Typography>
```

**✅ Good:**
```typescript
<Typography>Don&apos;t let funding constraints limit your business growth.</Typography>
<Typography>&ldquo;This is a quote&rdquo;</Typography>
```

### Database Model Rules

#### 1. Schema Types
**❌ Bad:**
```typescript
benefits_availed?: Record<string, any>;
features?: Record<string, any>;
```

**✅ Good:**
```typescript
benefits_availed?: Record<string, unknown>;
features?: Record<string, unknown>;
```

#### 2. Unused Parameters in Methods
**❌ Bad:**
```typescript
canApplyForLoan = function(loanType: 'personal' | 'business'): boolean {
  // loanType not used
}
```

**✅ Good:**
```typescript
canApplyForLoan = function(_loanType: 'personal' | 'business'): boolean {
  // or remove parameter if not needed
}
```

### Event Handler Types

#### 1. Form Events
**❌ Bad:**
```typescript
const handleChange = (event: any) => {
  setValue(event.target.value);
};
```

**✅ Good:**
```typescript
const handleChange = (event: React.ChangeEvent<HTMLInputElement>) => {
  setValue(event.target.value);
};

const handleSelectChange = (event: React.ChangeEvent<HTMLSelectElement>) => {
  setValue(event.target.value);
};
```

### Data Table Patterns

#### 1. Row ID Extraction
**❌ Bad:**
```typescript
getRowId={(row) => (row as any)._id}
```

**✅ Good:**
```typescript
getRowId={(row) => (row as { _id: string })._id}
```

#### 2. Column Rendering
**❌ Bad:**
```typescript
render: (value, row) => (
  <Box>
    {String((row as any).user_phone) || 'N/A'}
  </Box>
)
```

**✅ Good:**
```typescript
render: (value, row) => (
  <Box>
    {String((row as { user_phone?: string }).user_phone) || 'N/A'}
  </Box>
)
```

### API Response Patterns

#### 1. Aggregation Pipelines
**❌ Bad:**
```typescript
const pipeline: any[] = [...];
await Model.aggregate(pipeline);
```

**✅ Good:**
```typescript
const pipeline: unknown[] = [...];
await Model.aggregate(pipeline as never[]);
```

#### 2. Query Objects
**❌ Bad:**
```typescript
const query: any = {};
```

**✅ Good:**
```typescript
const query: Record<string, unknown> = {};
```

### Error Handling Patterns

#### 1. Try-Catch Blocks
**❌ Bad:**
```typescript
} catch (err) {
  console.error('Error:', err);
}
```

**✅ Good:**
```typescript
} catch (err) {
  console.error('Error:', err instanceof Error ? err.message : 'Unknown error');
}
```

### Common Fixes Applied

#### 1. Admin Pages
- Removed unused Material-UI icon imports
- Fixed `any` types in status color functions
- Added `useCallback` for fetch functions
- Fixed `ListItem` to `ListItemButton` usage

#### 2. API Routes
- Removed unused `NextRequest` imports
- Updated function signatures to use `Request` or no parameters
- Fixed validation data type assertions
- Corrected Mongoose property access with type assertions

#### 3. Components
- Removed unused imports across all component files
- Fixed `any` types in event handlers and props
- Escaped unescaped entities in JSX
- Added proper type assertions for Material-UI props

#### 4. Models
- Replaced `any` types with `unknown` in schema definitions
- Fixed unused parameters in instance methods
- Added proper type assertions for Mongoose document properties

### Build Verification Rules

#### Always run `npm run build` after making changes to verify:
- No TypeScript errors
- No ESLint errors (warnings are acceptable)
- Successful compilation

#### Notes:
- Warnings are acceptable and don't block builds
- Some Next.js internal type issues may appear but don't affect functionality
- Focus on fixing errors, not warnings, unless specifically requested
- Use type assertions sparingly and with specific types when possible
- Prefer `unknown` over `any` when the exact type is not known

### Quick Reference

| Issue | Fix |
|-------|-----|
| `any` type | Replace with specific type or `unknown` |
| Unused import | Remove from import statement |
| Unused variable | Prefix with `_` or remove |
| Missing useEffect deps | Wrap function in `useCallback` |
| Unescaped entity | Use `&apos;`, `&ldquo;`, `&rdquo;` |
| NextRequest unused | Remove import, use `Request` or no params |
| Mongoose property access | Use type assertion: `(doc as { prop: Type }).prop` |

## Support and Maintenance

### Regular Tasks
- Monitor application performance
- Review security logs
- Update dependencies
- Backup database
- Review user feedback

### Troubleshooting
- Check application logs
- Verify environment configuration
- Test database connectivity
- Review recent changes
- Check third-party service status